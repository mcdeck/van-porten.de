---
layout: post
title: Home Assistant
date: 2016-03-04 22:05:46.000000000 +01:00
type: post
parent_id: '0'
published: true
password: ''
status: publish
categories: []
tags:
- home assistant
- home automation
- homematic
- mqtt
- smarthome
meta:
  _wpcom_is_markdown: '1'
  _edit_last: '2'
  _oembed_5c8f0232e117bce3df22f3825354bdbc: "{{unknown}}"
  _oembed_c208c8def8e3a5141e57c80a1ab240b5: "{{unknown}}"
  _oembed_8f71f889ca5e9607264bfdf49b3a05a6: "{{unknown}}"
  _oembed_94b2b4f5ddf3d911b2b0a917ef2e38e7: "{{unknown}}"
  _oembed_5e3695f67d88fb3e418a5540d63b1a86: "{{unknown}}"
  _oembed_b7054f7f6a5fe472483a631931c3c595: "{{unknown}}"
  otw_grid_manager_content: "[]"
  _publicize_twitter_user: "@mcdeck"
  _oembed_954fd9177a88ff1c4fda0fbe0c353545: "{{unknown}}"
  _oembed_346519d7988d977625c1d0ecdadb3f99: "{{unknown}}"
  _oembed_cd38e0a3a382238c85e28e9eb823ea28: "{{unknown}}"
  _oembed_c26e0ee6ea7cdae63c242fe89a5f4fe2: "{{unknown}}"
  _oembed_edfd6e78e758e7cd9ff0c72d736d9809: "{{unknown}}"
  _jetpack_related_posts_cache: a:1:{s:32:"8f6677c9d6b0f903e98ad32ec61f8deb";a:2:{s:7:"expires";i:1523353617;s:7:"payload";a:3:{i:0;a:1:{s:2:"id";i:686;}i:1;a:1:{s:2:"id";i:438;}i:2;a:1:{s:2:"id";i:491;}}}}
  _yoast_wpseo_primary_category: '1'
  _wpas_done_all: '1'
  _wpas_skip_2057687: '1'
  _wpas_skip_2057689: '1'
  _wpas_skip_2057702: '1'
  _wpas_skip_7715001: '1'
  dsq_thread_id: '4634720609'
author:
  login: porten
  email: oliver@van-porten.de
  display_name: Oliver van Porten
  first_name: Oliver
  last_name: van Porten
---
<p>I believe home automation, at least for me, is to a large extent driven by the joy of trying out new things and extending my system. I think this is why, despite my previous endeavors into FHEM, I kept on tinkering with Home Assistant. I am a big Python fanboy and do dislike PERL with a passion, so it seems in a way natural to do so.</p>
<p>[caption id="attachment_520" align="aligncenter" width="300"]<a href="https://www.van-porten.de/wp-content/uploads/2016/02/Screenshot-2016-02-22-22.14.27.png" rel="attachment wp-att-520"><img class="wp-image-520 size-medium" src="{{ site.baseurl }}/assets/Screenshot-2016-02-22-22.14.27-300x151.png" alt="Home Assistant States" width="300" height="151" /></a> Snapshot of my Home Assistant setup - obviously it is a work in progress.[/caption]</p>
<p>There are a lot of things going on around<a href="https://home-assistant.io/" target="_blank"> Home Assistant</a> at the moment and I think that is quite fantastic. In this post I'd like to take a moment to describe the basic steps needed to get up and running with Home Assistant on a Raspberry Pi, including setting up InfluxDB and Grafana for all your graphing needs.</p>
<p><!--more--></p>
<p>But first things first. Let's start with an inventory of services that I need to run on my Raspberry.</p>
<ul>
<li><a href="https://home-assistant.io/" target="_blank">Home Assistant</a>: obviously</li>
<li><a href="https://git.zerfleddert.de/cgi-bin/gitweb.cgi/hmcfgusb" target="_blank">HMLANd</a>: because my Raspberry Pi doubles as <a href="http://www.homematic.com/" target="_blank">HomeMatic</a> LAN adapter for devices I installed in the basement</li>
<li><a href="https://influxdata.com/" target="_blank">InfluxDB</a>: Database for all kinds of measurements</li>
<li><a href="http://grafana.org/" target="_blank">Grafana</a>: Graphical front end to InfluxDB for charting</li>
<li><a href="http://mosquitto.org/" target="_blank">Mosquitto</a>: An MQTT broker</li>
<li><a href="https://github.com/owagner/hm2mqtt" target="_blank">hm2mqtt</a>: To translate <a href="http://www.homematic.com/" target="_blank">HomeMatic</a> to <a href="http://mqtt.org/" target="_blank">MQTT</a>. This doesn't run on the RPi in my setup, though, but on the <a href="http://www.eq-3.de/produkt-detail-zentralen-und-gateways/items/homematic-zentrale-ccu-2.html" target="_blank">CCU2</a> directly instead.</li>
</ul>
<h2>Mosquitto</h2>
<p>I firmly believe that eventually there will be one protocol to emerge in the whole Home Automation world that will finally allow connecting a myriad of devices and will be supported by virtually all vendors. While this is not the case today I am kind of betting <a href="http://mqtt.org/" target="_blank">MQTT</a> (and so are others). Home Assistant has excellent support for it, too, so it is the foundation of my setup.</p>
<p>Installation is pretty straight forward:</p>
<pre class="">wget http://repo.mosquitto.org/debian/mosquitto-repo.gpg.key
sudo apt-key add mosquitto-repo.gpg.key
cd /etc/apt/sources.list.d/
sudo wget http://repo.mosquitto.org/debian/mosquitto-jessie.list
sudo apt-get update
sudo apt-get install mosquitto</pre>
<p>Done. I will describe securing your local MQTT server in a future post, but we don't need any further setup for now. The MQTT broker is reachable on :1883.</p>
<p>I found that <a href="https://kamilfb.github.io/mqtt-spy/" target="_blank">mqtt-spy</a> is an incredibly useful tool to see what is going on in detail, so I suggest <a href="https://github.com/kamilfb/mqtt-spy/wiki/Downloads" target="_blank">grabbing a copy immediately</a>.</p>
<h2>Installing hm2mqtt</h2>
<p>hm2mqtt offers a bridge from HomeMatic to MQTT. It can run either directly on the CCU2 or on a separate system - I let it run on the CCU2 because I find that more convenient.</p>
<p>To install, your first need to build it. Simply clone the git repository of <a href="https://github.com/owagner/hm2mqtt" target="_blank">hm2mqtt from owagner</a> and let gradle build your addon package afterwards.</p>
<pre class="">git clone https://github.com/owagner/hm2mqtt hm2mqtt
cd hm2mqtt
gradle addon</pre>
<p>This will generate <strong><em><span class="s1">hm2mqtt/build/distributions/</span></em></strong><span class="s1"><strong><em>hm2mqtt-addon.tar.gz</em> </strong>which can be deployed to the CCU2. </span></p>
<p><span class="s1">To install the addon, point your browser to http://homematic-ccu2/ (or whatever hostname you chose for your CCU2) and navigate to the system settings, add ons dialog. </span></p>
<p>[caption id="attachment_532" align="aligncenter" width="300"]<a href="https://www.van-porten.de/wp-content/uploads/2016/03/Screenshot-2016-03-04-14.00.54.png" rel="attachment wp-att-532"><img class="size-medium wp-image-532" src="{{ site.baseurl }}/assets/Screenshot-2016-03-04-14.00.54-300x197.png" alt="The CCU2 addon dialog." width="300" height="197" /></a> The CCU2 addon dialog.[/caption]</p>
<p>At the bottom of the dialog, point the <em>choose file</em> dialog to the <em>hm2mqtt-addon.tar.gz</em> we built previously and select install. After the CCU2 reboots, you should see a hm2mqtt button in the system settings. This will take you to the configuration page of the hm2mqtt addon where we can set the broker address correctly.</p>
<p>[caption id="attachment_533" align="aligncenter" width="300"]<a href="https://www.van-porten.de/wp-content/uploads/2016/03/Screenshot-2016-03-04-14.35.03.png" rel="attachment wp-att-533"><img class="size-medium wp-image-533" src="{{ site.baseurl }}/assets/Screenshot-2016-03-04-14.35.03-300x116.png" alt="CCU2 system settings with hm2mqtt button" width="300" height="116" /></a> CCU2 system settings with hm2mqtt button[/caption]</p>
<p>Enter the address of the system you installed Mosquitto on, leaving the port 1883 as is. Save settings and then stop and start the daemon.</p>
<p>[caption id="attachment_534" align="aligncenter" width="300"]<a href="https://www.van-porten.de/wp-content/uploads/2016/03/Screenshot-2016-03-04-14.35.32.png" rel="attachment wp-att-534"><img class="size-medium wp-image-534" src="{{ site.baseurl }}/assets/Screenshot-2016-03-04-14.35.32-300x205.png" alt="hm2mqtt settings" width="300" height="205" /></a> hm2mqtt settings[/caption]</p>
<p>That's it. You can now fire up mqtt-spy, connect it to your broker and subscribe to <strong>hm/#.</strong></p>
<p>[caption id="attachment_524" align="aligncenter" width="300"]<a href="https://www.van-porten.de/wp-content/uploads/2016/02/Screenshot-2016-02-22-22.40.24.png" rel="attachment wp-att-524"><img class="wp-image-524 size-medium" src="{{ site.baseurl }}/assets/Screenshot-2016-02-22-22.40.24-300x220.png" alt="mqtt-spy" width="300" height="220" /></a> A screenshot of mqtt-spy connected to my local broker, receiving messages from HomeMatic[/caption]</p>
<p>You should start seeing MQTT messages from your CCU2 coming in.</p>
<h2>HMLANd</h2>
<p>As I wrote previously, my Home Assistant server doubles as a HMLANd range extender for my HomeMatic CCU2, allowing me to more reliably communicate with my sensors and actors that are currently placed in my basement.</p>
<p>Installing HMLANd is really straight forward. Simply grab the latest deb package from the <a href="https://git.zerfleddert.de/hmcfgusb/releases/" target="_blank">HMLANd release repository.</a> For a RaspberryPi you obviously want to pick the armhf package. In my case the latest available version was 0.102.</p>
<pre class="">wget https://git.zerfleddert.de/hmcfgusb/releases/debian/hmcfgusb_0.102-1_armhf.deb</pre>
<p>First we install some dependencies via apt and then install HMLANd via dpkg:</p>
<pre class="">apt-get install libusb-1.0-0-dev build-essential git
dpkg -i hmcfgusb_0.102-1_armhf.deb</pre>
<p>I also needed to configure some additional options to make it work.</p>
<pre class="">nano /etc/default/hmland</pre>
<p>For me I needed to emulate a LAN interface (the -I switch) and needed to make HMLANd listen on all interfaces (-l 0.0.0.0)</p>
<pre class="">HMLAND_OPTS="-l 0.0.0.0 -I"</pre>
<p>You should now be able to connect you CCU2 to the HMLANd via the system settings interface (LAN Gateway button).</p>
<p>[caption id="attachment_548" align="aligncenter" width="300"]<a href="https://www.van-porten.de/wp-content/uploads/2016/03/Screenshot-2016-03-04-21.53.42.png" rel="attachment wp-att-548"><img class="size-medium wp-image-548" src="{{ site.baseurl }}/assets/Screenshot-2016-03-04-21.53.42-300x138.png" alt="HMLAN configuration" width="300" height="138" /></a> Connecting HMLANd to a CCU2[/caption]</p>
<p>After a reboot of the CCU2 the interface should be usable. The LAN Gateway page should show status as <em><strong>connected</strong></em>.</p>
<h2>Influx DB and Grafana</h2>
<p>Influx DB is the database backend I use to store data from sensors. It is specifically built to do this, so seems like a good choice, plus there is native support for it in Home Assistant (and that is in fact where I got the idea of using it, to be honest).</p>
<p>Grafana is a web front end that allows you to create various views on the data in Influx DB (and some other databases, actually).</p>
<p>[caption id="attachment_521" align="aligncenter" width="300"]<a href="https://www.van-porten.de/wp-content/uploads/2016/02/Screenshot-2016-02-22-22.13.17.png" rel="attachment wp-att-521"><img class="wp-image-521 size-medium" src="{{ site.baseurl }}/assets/Screenshot-2016-02-22-22.13.17-300x184.png" alt="Grafana graph view" width="300" height="184" /></a> Grafana plotting data taken from my InfluxDB, filled by Home Assistant[/caption]</p>
<p>Installing everything is again very straight forward. Unless you want to compile all packages yourself I suggest you download the pre-built debs from here. The packages provided here are a mirror of those built by <a href="http://padcom13.blogspot.de/2015/12/influxdb-telegraf-and-grafana-on.html" target="_blank">padcom</a>. You can also <a href="http://padcom13.blogspot.de/2015/12/influxdb-telegraf-and-grafana-on.html" target="_blank">go to his page and get the original files</a>.</p>
<ul>
<li><a href="https://www.van-porten.de/wp-content/uploads/2016/03/influxdb_0.9.6.1_armhf.deb">influxdb_0.9.6.1_armhf.deb</a></li>
<li><a href="https://www.van-porten.de/wp-content/uploads/2016/03/telegraf_0.3.0-beta2_armhf.deb">telegraf_0.3.0-beta2_armhf.deb</a></li>
<li><a href="https://www.van-porten.de/wp-content/uploads/2016/03/grafana_2.6.0_armhf.deb">grafana_2.6.0_armhf.deb</a></li>
</ul>
<p>Once you downloaded the deb simply install them using dpkg and fix missing dependencies afterwards.</p>
<pre class="">sudo dpkg -i influxdb_0.9.6.1_armhf.deb
sudo dpkg -i telegraf_0.3.0-beta2_armhf.deb
sudo dpkg -i grafana_2.6.0_armhf.deb
sudo apt-get install -f
</pre>
<p class="">With that done, we can finalize the setup and start the Grafana server. Note that we need to create an empty <strong><em>/etc/default/telegraf file</em></strong> - otherwise you will see errors when starting Telegraf.</p>
<pre class="">sudo touch /etc/default/telegraf
sudo /bin/systemctl daemon-reload
sudo /bin/systemctl enable grafana-server
sudo /bin/systemctl start grafana-server</pre>
<p>As a final step, we setup a database for use in Home Assistant (see also the <a href="https://home-assistant.io/blog/2015/12/07/influxdb-and-grafana/" target="_blank">post in the home assistant blog</a> for further details)</p>
<pre class="">$ influx
Visit https://enterprise.influxdata.com to register for updates, InfluxDB server management, and monitoring.
Connected to http://localhost:8086 version 0.9.5.1
InfluxDB shell 0.9.5.1
> CREATE DATABASE home_assistant
> CREATE DATABASE telegraf
> CREATE USER "home-assistant" WITH PASSWORD 'home-assistant!'</pre>
<p>The one thing we want to do for Grafana now is setting up InfluxDB as a data source. The <a href="http://docs.grafana.org/datasources/influxdb/" target="_blank">Grafana documentation</a> describes how to do this in great detail, so I will not repeat it here. I think once you have this done it is a matter of evaluating that data that is logged and sorting it into meaningful views and plots. That is in fact something I also still have to do :)</p>
<h2>Installing Home Assistant</h2>
<p>Finally. The main piece of software we are doing all this for. We will cover two things here. First, we'll install home assistant in a central location using a virtual environment. Secondly, we will make it start automatically at boot time.</p>
<p>I will talk about the procedure to install a development snapshot here, because that is what I typically use and play around with. Installing a release version is simply a matter of using <em><strong>pip install</strong> </em>after you've setup the virtual environment, I think.</p>
<p>First, we install some prerequisites:</p>
<pre class="">sudo apt-get install git
sudo apt-get install python3.4 virtualenv python-pip
sudo pip install build-essential
sudo apt-get install python3.4-dev</pre>
<p>We then create the directories where we want our configuration and virtual environment to live, and install the virtual environment:</p>
<pre class="">sudo mkdir /opt/home-assistant
sudo chown pi:pi /opt/home-assistant
virtualenv -p python3.4 /opt/home-assistant/virtualenv</pre>
<p>Once we have that, we clone the official home assistant repo dev branch and</p>
<pre class="">git clone https://github.com/balloob/home-assistant</pre>
<p>With the clone done, we are now ready to install Home Assistant into our virtual environment (mind the <em>source</em> to activate the virtual environment first):</p>
<pre class="">source /opt/home-assistant/virtualenv/bin/activate
cd home-assistant
python setup.py install
pip install -r requirements_all.txt</pre>
<p>Doing the final install of everything that is in the requirements_all.txt is actually not needed - HomeAssistant will install dependencies into <strong>/opt/home-assistant/config/lib</strong> - but I tend to do that anyway to more easily see when things go wrong. It will also come in handy when you want to install a custom version of some dependency.</p>
<h2>Automatically starting Home Assistant</h2>
<p>The <a href="https://home-assistant.io/getting-started/autostart/" target="_blank">Home Assistant documentation</a> covers the procedure to start Home Assistant as a service quite well, so I will be brief. The hass-daemon startup script can be <a href="https://raw.githubusercontent.com/balloob/home-assistant/dev/script/hass-daemon" target="_blank">downloaded from the git repository</a> and just needs some small modifications.</p>
<pre class="">wget https://raw.githubusercontent.com/balloob/home-assistant/dev/script/hass-daemon
sudo cp hass-daemon /etc/init.d/hass-daemon
sudo chmod +x /etc/init.d/hass-daemon</pre>
<p>Once this is done, we can make the necessary adjustments:</p>
<pre class="">sudo nano /etc/init.d/hass-daemon</pre>
<p>Simply update the following variables at the top of the file:</p>
<pre class="">PRE_EXEC="source /opt/homea-ssistant/virtualenv/bin/activate;"
RUN_AS="pi"
PID_FILE="/opt/home-assistant/run/hass.pid"
CONFIG_DIR="/opt/home-assistant/config"</pre>
<p>Finally, we create the run directory, add it to the default startup sequence and install the hass-daemon properly</p>
<pre class="">mkdir /opt/home-assistant/run
sudo update-rc.d hass-daemon defaults
sudo service hass-daemon install</pre>
<p>And then we start it up:</p>
<pre class="">sudo service hass-daemon start</pre>
<p>You should now be able to browse to http://&lt;your server&gt;:8123/ and see you new Home Assistant installation.</p>
<p>I will cover the details of my current setup in detail in a future post. For now please refer to the <a href="https://home-assistant.io/getting-started/configuration/" target="_blank">excellent Home Assistant documentation</a> to get started.</p>
