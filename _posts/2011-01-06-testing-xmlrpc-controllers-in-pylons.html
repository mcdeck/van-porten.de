---
layout: post
title: Testing XMLRPC Controllers in Pylons
date: 2011-01-06 13:34:00.000000000 +01:00
type: post
parent_id: '0'
published: true
password: ''
status: publish
categories: []
tags:
- Pylons
- Python
- webtest
- xmlrpc
- XMLRPCController
meta:
  _wpas_done_all: '1'
  _jetpack_related_posts_cache: a:1:{s:32:"8f6677c9d6b0f903e98ad32ec61f8deb";a:2:{s:7:"expires";i:1522615022;s:7:"payload";a:3:{i:0;a:1:{s:2:"id";i:147;}i:1;a:1:{s:2:"id";i:146;}i:2;a:1:{s:2:"id";i:143;}}}}
  dsq_thread_id: '1350987487'
author:
  login: porten
  email: oliver@van-porten.de
  display_name: Oliver van Porten
  first_name: Oliver
  last_name: van Porten
---
<p>Testing is one of the essential tasks in modern software development, so<br />
it is only natural to want to test an application as thoroughly as<br />
possible.</p>
<p>I'm currently working on an application that offers a service via<br />
xmlrpc. For a client side implementaion I use python's <a class="reference external" href="http://docs.python.org/library/xmlrpclib.html">xmlrpclib</a> and<br />
that is working well. Then again, I obviously want to test the xmlrpc<br />
functionality also during regular unit and functional tests and not only<br />
using the client. What's more, having to instantiate a server to be able<br />
to run tests is cumbersome at best.</p>
<p>Unfortunatly, Pylons does not offer a method to test xmlrpc controllers<br />
out of the box. The solution I found is not quite as complicated as I<br />
had feared at first. Read more after the break.</p>
<p>For the above mentiond reasons, here is my solution for testing a<br />
XMLRPCController in Pylons using a mock transport for xmlrpclib.</p>
<p>This solution is largely based on the excellent post by <a class="reference external" href="http://schurger.org/wordpress/2009/12/unit-tests-with-pylons-and-its-xmlrpccontroller/">Jean Schruger<br />
on his Blog</a> .</p>
<div class="highlight">
<pre><span class="kn">from</span> <span class="nn">myapp.tests</span> <span class="kn">import</span> <span class="o">*</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">StringIO</span> <span class="kn">import</span> <span class="n">StringIO</span>
<span class="kn">import</span> <span class="nn">xmlrpclib</span>
<span class="kn">from</span> <span class="nn">xmlrpclib</span> <span class="kn">import</span> <span class="n">ServerProxy</span>

<span class="k">class</span> <span class="nc">WSGILikeHTTP</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">app</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">app</span> <span class="o">=</span> <span class="n">app</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">headers</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>

  <span class="k">def</span> <span class="nf">putrequest</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">handler</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="n">method</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">handler</span> <span class="o">=</span> <span class="n">handler</span>

  <span class="k">def</span> <span class="nf">putheader</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

  <span class="k">def</span> <span class="nf">endheaders</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">pass</span>

  <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">body</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">body</span>

  <span class="k">def</span> <span class="nf">getfile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">content</span>

  <span class="k">def</span> <span class="nf">getreply</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">&quot;POST&quot;</span><span class="p">:</span>
      <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">handler</span><span class="p">,</span>
                        <span class="n">headers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">,</span>
                        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">body</span> <span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">unicode_body</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">WSGIAppTransport</span><span class="p">(</span><span class="n">xmlrpclib</span><span class="o">.</span><span class="n">Transport</span><span class="p">):</span>
  <span class="c"># Only here to pass the &#39;app&#39;</span>
  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app</span><span class="p">):</span>
    <span class="n">xmlrpclib</span><span class="o">.</span><span class="n">Transport</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">app</span> <span class="o">=</span> <span class="n">app</span>

  <span class="c"># return the fake httplib.HTTP(host)</span>
  <span class="k">def</span> <span class="nf">make_connection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host</span><span class="p">):</span>
    <span class="n">host</span><span class="p">,</span> <span class="n">extra_headers</span><span class="p">,</span> <span class="n">x509</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_host_info</span><span class="p">(</span><span class="n">host</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">WSGILikeHTTP</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">TestXmlrpcController</span><span class="p">(</span><span class="n">TestController</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">test_index</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="n">server</span> <span class="o">=</span> <span class="n">ServerProxy</span><span class="p">(</span><span class="s">&#39;http://admin:admin@dummy/xmlrpc&#39;</span><span class="p">,</span>
                            <span class="n">transport</span><span class="o">=</span><span class="n">WSGIAppTransport</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="p">))</span>
      <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="n">server</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">listMethods</span><span class="p">()</span>
</pre>
</div>
