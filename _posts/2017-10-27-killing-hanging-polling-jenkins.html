---
layout: post
title: Killing hanging polling in Jenkins
date: 2017-10-27 14:01:17.000000000 +02:00
type: post
parent_id: '0'
published: true
password: ''
status: publish
categories: []
tags: []
meta:
  _edit_last: '2'
  _yoast_wpseo_content_score: '30'
  _yoast_wpseo_primary_category: ''
  _jetpack_related_posts_cache: a:1:{s:32:"8f6677c9d6b0f903e98ad32ec61f8deb";a:2:{s:7:"expires";i:1523324027;s:7:"payload";a:3:{i:0;a:1:{s:2:"id";i:140;}i:1;a:1:{s:2:"id";i:137;}i:2;a:1:{s:2:"id";i:145;}}}}
  _wpas_done_all: '1'
  dsq_thread_id: '6252352864'
author:
  login: porten
  email: oliver@van-porten.de
  display_name: Oliver van Porten
  first_name: Oliver
  last_name: van Porten
---
<p>For one reason or another Jenkins sometimes gets stuck when polling SCM (which is, apparently, a known issue, cf <a href="https://issues.jenkins-ci.org/browse/JENKINS-5413" target="_blank" rel="noopener">[JENKINS-5413] SCM polling getting hung - Jenkins JIRA</a> ).</p>
<p>This can lead to a variety of problems.</p>
<p>For us, some pipelines simply would not run anymore automatically.</p>
<p>To get rid of the hanging polling jobs, I came up the following <strong>Groovy System Script</strong> (note the "system" part). You can simply add this to a freestyle job and run at regular intervals or via the script console of the master (Manage Jenkins -&gt; Script Console)</p>
<pre class="lang:java decode:true ">import hudson.model.Hudson
import hudson.model.Hudson
import hudson.triggers.SCMTrigger

now_ms = new Date().getTime()
hour_ms = 1000 * 60 * 60
// 6 hours
threshold = 6 * hour_ms 

SCM_TRIGGER_DESCRIPTOR = Hudson.instance.getDescriptorOrDie(SCMTrigger.class)
runners =  SCM_TRIGGER_DESCRIPTOR.getRunners()
runners.each() { it ->
  def tgt_name = it.target.asItem().getName()
  def dur = now_ms - it.startTime
  
  println tgt_name + ' running for ' + it.duration
  if(dur > threshold) { 
    tgt = Thread.getAllStackTraces().keySet().find() { item ->
      item.getName().contains("SCM polling") && item.getName().contains(tgt_name)
    }
    
    if (tgt) {
      println '-- stuck in polling, canceling '
      println '---> ' + tgt
    
      tgt.interrupt()
    } else {
      println '-- not stuck in polling '
    }
  } else {
    println '-- below threshold '
  }
  println '---'
}</pre>
